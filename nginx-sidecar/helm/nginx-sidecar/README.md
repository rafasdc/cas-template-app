# nginx-sidecar Helm Chart

This helm chart is an out-of-the-box helper tool to handle SSL termination on any web-facing application on OpenShift 4.
It includes:

- 2 PVCs for the acme challenge and certificates
- 2 CronJobs for certificate initial issue and renewal
- a ConfigMap object for the nginx configuration
- templates to include in the Deployment object making use of this sidecar

## Usage

- Import this chart in the `Chart.yaml`

  ```yaml
  apiVersion: v2
  name: my-app
  description: My Helm Chart
  type: application
  version: 1.2.3
  appVersion: 1.2.3
  dependencies:
    - name: nginx-sidecar
      repository: https://bcgov.github.io/cas-template-app
      version: 0.1.1
  ```

- Use the templates in the deployment - match the template with the alias of the chart that was used

  ```yaml
  # deploy.yaml
  kind: Deployment
  ...
  spec:
    template:
      ...
      spec:
        containers:
  {{- if (index .Values "nginx-sidecar") }}
  {{- include "nginx-sidecar.deployment-container.tpl" (index .Values "nginx-sidecar") | indent 6 }}
  {{- end }}
        volumes:
  {{- if (index .Values "nginx-sidecar") }}
  {{- include "nginx-sidecar.deployment-volumes.tpl" (index .Values "nginx-sidecar") | indent 8 }}
  {{- end }}
  ```

- Trigger (manually or automatically) the issue and renewal CronJobs, as needed

## Values configuration

| Parameter          | Description                                                                                      | Default                                        |
| :----------------- | :----------------------------------------------------------------------------------------------- | :--------------------------------------------- |
| `image.repository` | Repository of the OpenShift-compatible nginx image                                               | `gcr.io/ggl-cas-storage/cas-nginx`             |
| `image.tag`        | Tag for the OpenShift-compatible nginx image                                                     | `latest`                                       |
| `image.pullPolicy` | Pull Policy for the OpenShift-compatible nginx image                                             | `Always`                                       |
| `objectNamePrefix` | Prefix for objects generated by this chart                                                       | `nginx-sidecar`                                |
| `sslTermination`   | Whether SSL Termination is enabled                                                               | `true`                                         |
| `caServerSecret`   | If set, the acme issue/renewal scripts use a custom server, Let's Encrypt will be used otherwise | `null`                                         |
| `caServerKey`      | If set, the acme issue/renewal scripts use a custom server, Let's Encrypt will be used otherwise | `null`                                         |
| `caAccountEmail`   | Email address for the certificate                                                                | `ggircs@gov.bc.ca`                             |
| `storageClassName` | Storage class to use for the acme PVCs                                                           | `netapp-file-standard`                         |
| `renewalDays`      | Expiry of the certificate, after how many days it needs to be renewed                            | `60`                                           |
| `hostName`         | Host name for the application, should match the OpenShift route configuration                    | `example-climate-action-secretariat.gov.bc.ca` |
| `internalPort`     | Internal port of the nginx server, matches the port the service exposes                          | `null`                                         |
| `port`             | Exposed port of the nginx server                                                                 | `null`                                         |
